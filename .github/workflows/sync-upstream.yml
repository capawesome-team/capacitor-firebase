name: Sync from Upstream

on:
  schedule:
    # Run every day at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Upstream branch to sync from'
        required: false
        default: 'main'

jobs:
  sync:
    runs-on: ubuntu-latest
    name: "Sync changes from upstream repository"
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check out
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: '${{ secrets.PERSONAL_ACCESS_TOKEN }}'

      - name: Configure Git
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/capawesome-team/capacitor-firebase.git || true
          git fetch upstream

      - name: Check for upstream changes
        id: check_changes
        run: |
          UPSTREAM_BRANCH="${{ github.event.inputs.branch || 'main' }}"
          git fetch upstream $UPSTREAM_BRANCH

          # Check if there are new commits
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/$UPSTREAM_BRANCH)

          if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ]; then
            echo "No new changes from upstream"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "New changes detected from upstream"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          fi

      - name: Create sync branch
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="sync-upstream-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME

      - name: Merge upstream changes
        if: steps.check_changes.outputs.has_changes == 'true'
        id: merge
        run: |
          UPSTREAM_BRANCH="${{ github.event.inputs.branch || 'main' }}"

          # Try to merge upstream changes
          if git merge upstream/$UPSTREAM_BRANCH --no-edit -m "chore: sync from upstream capawesome-team/capacitor-firebase"; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Merge successful"
          else
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Merge conflicts detected"

            # Get list of conflicting files
            CONFLICTS=$(git diff --name-only --diff-filter=U)
            echo "conflicts<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFLICTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Abort the merge
            git merge --abort
          fi

      - name: Push sync branch
        if: steps.check_changes.outputs.has_changes == 'true' && steps.merge.outputs.merge_status == 'success'
        run: |
          git push origin ${{ env.branch_name }}

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true' && steps.merge.outputs.merge_status == 'success'
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          branch: ${{ env.branch_name }}
          title: "chore: sync from upstream capawesome-team/capacitor-firebase"
          body: |
            ## üîÑ Upstream Sync

            This PR syncs changes from the upstream repository [capawesome-team/capacitor-firebase](https://github.com/capawesome-team/capacitor-firebase).

            ### Changes Included
            - Latest commits from upstream `${{ github.event.inputs.branch || 'main' }}` branch
            - Upstream commit: `${{ steps.check_changes.outputs.upstream_commit }}`

            ### Automated Process
            - ‚úÖ Tests will run automatically
            - ‚úÖ Auto-merge enabled if all checks pass
            - ü§ñ Generated by GitHub Actions

            ---

            **Note:** This PR will automatically merge if all tests pass. If tests fail, manual review will be required.
          labels: |
            upstream-sync
            automated
          draft: false

      - name: Enable auto-merge
        if: steps.check_changes.outputs.has_changes == 'true' && steps.merge.outputs.merge_status == 'success' && steps.create_pr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.create_pr.outputs.pull-request-number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Comment on conflicts
        if: steps.check_changes.outputs.has_changes == 'true' && steps.merge.outputs.merge_status == 'conflict'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.create_pr.outputs.pull-request-number }}
          body: |
            ## ‚ö†Ô∏è Merge Conflicts Detected

            The upstream sync encountered merge conflicts in the following files:

            ```
            ${{ steps.merge.outputs.conflicts }}
            ```

            **Manual resolution required:**
            1. Check out this branch locally
            2. Resolve the conflicts
            3. Push the resolved changes

            The PR will auto-merge once tests pass.

      - name: Create issue for conflicts
        if: steps.check_changes.outputs.has_changes == 'true' && steps.merge.outputs.merge_status == 'conflict'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "‚ö†Ô∏è Upstream sync failed due to merge conflicts"
          content: |
            ## Upstream Sync Failed

            An automatic sync from [capawesome-team/capacitor-firebase](https://github.com/capawesome-team/capacitor-firebase) failed due to merge conflicts.

            ### Conflicting Files
            ```
            ${{ steps.merge.outputs.conflicts }}
            ```

            ### Action Required
            1. Manually resolve the conflicts
            2. Review and merge the changes
            3. Update our fork with resolved conflicts

            ### Sync Details
            - Upstream commit: `${{ steps.check_changes.outputs.upstream_commit }}`
            - Attempted branch: `${{ env.branch_name }}`
          labels: |
            upstream-sync
            merge-conflict
            manual-review-required
